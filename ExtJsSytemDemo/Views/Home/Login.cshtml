@{
    ViewBag.Title = "Login";
}

@section script
{

   <script type="text/javascript">

       Ext.onReady(function () {
           Ext.QuickTips.init();

           // Create a variable to hold our EXT Form Panel. 
           // Assign various config options as seen.     
           var login = Ext.create('Ext.form.Panel', {
               labelWidth: 80,
               url: 'Check',
               frame: true,
               //title: '请登陆',
               header: false,
               defaultType: 'textfield',
               monitorValid: false,
               // Specific attributes for the text fields for username / password. 
               // The "name" attribute defines the name of variables sent to the server.
               items: [{
                   fieldLabel: '用户名',
                   name: 'loginUsername',
                   allowBlank: true
               }, {
                   fieldLabel: '密码',
                   name: 'loginPassword',
                   inputType: 'password',
                   allowBlank: true
               }],

               // All the magic happens after the user clicks the button     
               buttons: [{
                   text: '登陆',
                   formBind: false,
                   // Function that fires when user clicks the button 
                   handler: function () {

                       var data = login.getForm().getValues();
                       alert(Ext.encode(data));

                       login.getForm().submit({
                           method: 'POST',
                           waitTitle: '连接服务器',
                           waitMsg: '传送数据...',

                           // Functions that fire (success or failure) when the server responds. 
                           // The one that executes is determined by the 
                           // response that comes from login.asp as seen below. The server would 
                           // actually respond with valid JSON, 
                           // something like: response.write "{ success: true}" or 
                           // response.write "{ success: false, errors: { reason: 'Login failed. Try again.' }}" 
                           // depending on the logic contained within your server script.
                           // If a success occurs, the user is notified with an alert messagebox, 
                           // and when they click "OK", they are redirected to whatever page
                           // you define as redirect. 

                           success: function () {

                               var redirect = 'Index';
                               window.location = redirect;
                               
//                               Ext.Msg.alert('Status', 'Login Successful!', function (btn, text) {
//                                   if (btn == 'ok') {
//                                       var redirect = 'Home/Index';
//                                       window.location = redirect;
//                                   }
//                               });

                           },

                           // Failure function, see comment above re: success and failure. 
                           // 如果登录失败，弹出对话框。 

                           failure: function (form, action) {
                               if (action.failureType == 'server') {
                                   obj = Ext.util.JSON.decode(action.response.responseText);
                                   Ext.Msg.alert('登陆失败!', obj.errors.reason);
                               } else {
                                   Ext.Msg.alert('Warning!', 'Authentication server is unreachable : ' + action.response.responseText);
                               }
                               login.getForm().reset();
                           }
                       });
                       
                   }
               }]
           });


           // This just creates a window to wrap the login form. 
           // The login object is passed to the items collection.       
           var win = new Ext.Window({
               layout: 'fit',
               title: '登录',
               width: 300,
               height: 150,
               closable: false,
               resizable: false,
               plain: true,
               border: false,
               items: [login]
           });
           win.show();
       });

   </script>    
}


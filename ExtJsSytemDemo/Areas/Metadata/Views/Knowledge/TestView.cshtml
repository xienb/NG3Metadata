@{
    ViewBag.Title = "TestView";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section script
{

    <script type="text/javascript" src="../../../../Scripts/ngcommon.js"></script>
    <script type="text/javascript">
        var isLoad = false;
        Ext.onReady(function () {
            
            var mainTreeStore = Ext.create('Ext.data.TreeStore', {
                autoLoad: false,
                proxy: {
                    type: 'ajax',
                    url: '@Url.Content("LoadMainTree")'
                },
                folderSort: true,
                sorters: [{
                    property: 'text',
                    direction: 'ASC'
                }]
                //listeners: {
                //    beforeload: function (store, operation, options) {
                //        if (isLoad) {
                //            store.fireEvent();
                //            return false;
                //        }
                //        isLoad = true;
                //    }
                //}
            });

            //menu
            var mainTree = new Ext.tree.TreePanel(
                {
                    id: "mainTree",
                    store: mainTreeStore,
                    region: "west",
                    title: "知识模型",
                    autoScroll: true,
                    enableTabScroll: true,
                    collapsible: true,
                    collapsed: false,
                    split: true,
                    rootVisible: false,
                    lines: true,
                    useArrows: true,
                    width: 220,
                    minSize: 220,
                    maxSize: 220,
                    viewConfig: {
                        plugins: {
                            ptype: 'treeviewdragdrop'
                        }
                    }

                });

            var addNode = function() {
                var selectionModel = mainTree.getSelectionModel();
                var selectedNodes = selectionModel.selected.items;
                if (selectedNodes.length > 0) {
                    var selectedNode = selectedNodes[0];
                    //selectedNode.expand();
                    var treeId = NewGuid();
                    selectedNode.appendChild({ id: treeId, text: '我的叶子', leaf: true });
                    selectedNode.expand();
                    var record = selectedNode.findChild("id", treeId, true);
                    selectionModel.select(record);

                }
            };
            
            var editNode = function (name) {
                var selectionModel = mainTree.getSelectionModel();
                var selectedNodes = selectionModel.selected.items;
                if (selectedNodes.length > 0) {
                    var selectedNode = selectedNodes[0];
                    selectedNode.set('text', name);

                }
            };
            
            var deleteNode = function () {
                var selectionModel = mainTree.getSelectionModel();
                var selectedNodes = selectionModel.selected.items;
                if (selectedNodes.length > 0) {
                    var selectedNode = selectedNodes[0];
                    var previousNode = selectedNode.previousSibling;
                    var parentNode = selectedNode.parentNode;
                    var nextNode = selectedNode.nextSibling;
                    selectedNode.remove();
                    if (previousNode) {
                        selectionModel.select(previousNode);
                    } else {
                        if (nextNode) {
                            selectionModel.select(nextNode);
                        } else {
                            if (parentNode) {
                                selectionModel.select(parentNode);
                            }
                        }
                    }
                }
            };
            

            
            var mainContextMenu = Ext.create('Ext.menu.Menu', {
                margin: '0 0 10 0',
                //floating: false,
                items: [
                    {
                        id: 'addMenu',
                        text: '新增节点',
                        handler: function () {
                            addNode();
                        }
                    },
                    {
                        id: 'editMenu',
                        text: '修改名称',
                        handler: function () {
                            editNode('修改后的名称');
                        }
                    },
                    {
                        id: 'deleteMenu',
                        text: '删除节点',
                        handler: function () {
                            deleteNode();
                        }
                    }
                ]
            });
            
            mainTree.on('itemcontextmenu', function (view, record, item, index, e, eOpts) {
                e.preventDefault();
                mainContextMenu.showAt(e.getXY());
                e.stopEvent();
            });

            
            new Ext.Viewport(
                {
                    id: "viewPort",
                    layout: 'border',
                    items:
                    [
                        mainTree
                    ]
                });

        });

    </script>

}
